import heapq
from copy import deepcopy

DIRECTIONS = [(-1,0), (0,1), (1,0), (0,-1)]

def within_grid(row, col ,grid):
    if 0 <= row < len(grid) and 0 <= col < len(grid[0]):
        return True
    return False

def print_debug(grid, debug):
    for row in range(len(grid)):
        s = ""
        for col in range(len(grid[0])):
            s += '#' if (row,col) in debug else '.'
        print(s)

def part1(grid):
    heap = [(0,0,0,1,0,set())]
    end = (len(grid)-1, len(grid[0])-1)
    visited = {}
    while heap:
        energy, row, col, dir, limit, debug = heapq.heappop(heap)

        if (row,col) == end:
            print_debug(grid, debug)
            print("energy", energy)
            break

        # left, right, straight
        for new_dir in [1,3,4]:
            new_dir = (dir + new_dir) % 4
            head_to = DIRECTIONS[new_dir]
            nrow, ncol = row + head_to[0], col + head_to[1] 
            if not within_grid(nrow, ncol, grid):
                continue
            if new_dir == dir and limit > 2:
                continue
            new_limit = limit + 1 if new_dir == dir else 1
            new_energy = energy + grid[nrow][ncol]
            key = (nrow, ncol, new_dir, new_limit)
            new_d = deepcopy(debug)
            new_d.add((nrow, ncol))
            if key not in visited or new_energy < visited[key]:
                visited[key] = new_energy
                heapq.heappush(heap, (new_energy, nrow, ncol, new_dir, new_limit, new_d))

def part2(grid):
    heap = [(0,0,0,1,0,set())]
    end = (len(grid)-1, len(grid[0])-1)
    visited = {}
    while heap:
        energy, row, col, dir, limit, debug = heapq.heappop(heap)

        if (row,col) == end and limit >= 4:
            print_debug(grid, debug)
            print("energy", energy)
            break

        # left, right, straight
        for new_dir in [1,3,4]:
            new_dir = (dir + new_dir) % 4
            head_to = DIRECTIONS[new_dir]
            nrow, ncol = row + head_to[0], col + head_to[1] 
            if not within_grid(nrow, ncol, grid):
                continue
            if new_dir != dir and limit <= 3:
                continue
            if new_dir == dir and limit >= 10:
                continue
            new_limit = limit + 1 if new_dir == dir else 1
            new_energy = energy + grid[nrow][ncol]
            key = (nrow, ncol, new_dir, new_limit)
            new_d = deepcopy(debug)
            new_d.add((nrow, ncol))
            if key not in visited or new_energy < visited[key]:
                visited[key] = new_energy
                heapq.heappush(heap, (new_energy, nrow, ncol, new_dir, new_limit, new_d))

# part1 energy 843

def solution():
    filename = "./inputs/q17.txt"
    grid = [[int(num) for num in line] for line in open(filename).read().split('\n')]
    # part1(grid)
    part2(grid)
solution()


# .##########........#########.................................................................................................................
# ..........#........#.......#.................................................................................................................
# ..........#........#.......#.............##########.........##########.......................................................................
# ..........#........#.......#.............#........#.........#........#.......................................................................
# ..........##########.......###########...#........#.........#........#...............#######.................................................
# .....................................#...#........#.........#........#...............#.....#.................................................
# .....................................#...#........###########........########........#.....#.................................................
# .....................................#...#..................................#........#.....#.................................................
# .....................................#####..................................#........#.....#######...........................................
# ............................................................................#........#...........#...........................................
# ............................................................................##########...........#...........................................
# .................................................................................................#...........................................
# .................................................................................................#...........................................
# .................................................................................................#########...................................
# .........................................................................................................#...................................
# .........................................................................................................#...................................
# .........................................................................................................#...................................
# .........................................................................................................###########.........................
# ...................................................................................................................#.........................
# ...................................................................................................................#.........................
# ...................................................................................................................#.........................
# ...................................................................................................................#.........................
# ...................................................................................................................#.........................
# ...................................................................................................................#.........................
# ...................................................................................................................#.........................
# ...................................................................................................................#######...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#...................
# .........................................................................................................................#####...............
# .............................................................................................................................#...............
# .............................................................................................................................#...............
# .............................................................................................................................#...............
# .............................................................................................................................#...............
# .............................................................................................................................#...............
# .............................................................................................................................#...............
# .............................................................................................................................#######.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#.........
# ...................................................................................................................................#####.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#####.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# .......................................................................................................................................#####.
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#####.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# ...........................................................................................................................................#.
# .......................................................................................................................................#####.
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................#.....
# .......................................................................................................................................######
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ........................................................................................................................................#####
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#####
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ........................................................................................................................................#####
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#....
# ........................................................................................................................................#####
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#
# ............................................................................................................................................#